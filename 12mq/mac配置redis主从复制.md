[TOC]
# mac配置redis主从复制

## docker安装redis
依次执行以下命令：
```
# 拉取最新版本redis
docker pull redis
```

## 配置文件
```
port 3369
```

运行容器
```
# 主节点
sudo docker run -p 6379:6379 --name redis -v /Users/wyf/Desktop/java_adv/homework/12mq/conf/redis.conf:/etc/redis/redis.conf  -v /Users/wyf/Desktop/java_adv/homework/12mq/conf/data:/data -d redis redis-server /etc/redis/redis.conf --appendonly yes
# 从节点
sudo docker run -p 6380:6379 --name redis-slave -v /Users/wyf/Desktop/java_adv/homework/12mq/conf/redis.conf:/etc/redis/redis.conf  -v /Users/wyf/Desktop/java_adv/homework/12mq/conf/dataSlave:/data -d redis redis-server /etc/redis/redis.conf --appendonly yes
```
## 配置主从复制
使用如下命令查看容器ip地址
```
# 查看容器ip地址
docker inspect redis        --172.17.0.2
docker inspect redis-slave  --172.17.0.3
```
进入从节点，配置主从复制
```
docker exec -it redis-slave redis-cli
# 配置主节点信息
slaveof 172.17.0.2 6379
```
在redis命令行`info`命令查看配置情况
```
# 主节点
role:master
connected_slaves:1
slave0:ip=172.17.0.3,port=6379,state=online,offset=17215,lag=1
master_failover_state:no-failover
# 从节点
role:slave
master_host:172.17.0.2
master_port:6379
master_link_status:up
```
# 配置sentinel高可用

## 配置文件
```
# sentinel0.conf
sentinel myid 8d992c54df8f8677b0b345825f61fb733c73d14c
sentinel deny-scripts-reconfig yes
sentinel monitor mymaster 127.0.0.1 6379 2
sentinel down-after-milliseconds mymaster 10000
# Generated by CONFIG REWRITE
protected-mode no
port 26379
user default on nopass sanitize-payload ~* &* +@all
dir "/Users/wyf/Desktop/java_adv/homework/12mq/conf"
```

```
# sentinel1.conf
sentinel myid 8d992c54df8f8677b0b345825f61fb733c73d14d
sentinel deny-scripts-reconfig yes
sentinel monitor mymaster 127.0.0.1 6379 2
sentinel down-after-milliseconds mymaster 10000
# Generated by CONFIG REWRITE
protected-mode no
port 26380
user default on nopass sanitize-payload ~* &* +@all
dir "/Users/wyf/Desktop/java_adv/homework/12mq/conf"
```
## 创建哨兵
启动redis sentinel，也可以使用`reids-server setinel.conf --sentinel`
```
redis-sentinel sentinel0.conf
redis-sentinel sentinel1.conf
```
查看sentinel日志是否正常

```
36153:X 25 Jul 2021 20:20:00.058 # Sentinel ID is 8d992c54df8f8677b0b345825f61fb733c73d14c
36153:X 25 Jul 2021 20:20:00.058 # +monitor master mymaster 127.0.0.1 6379 quorum 2
36153:X 25 Jul 2021 20:20:00.059 * +slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379
36153:X 25 Jul 2021 20:20:17.981 * +sentinel sentinel 8d992c54df8f8677b0b345825f61fb733c73d14d 127.0.0.1 26380 @ mymaster 127.0.0.1 6379
36153:X 25 Jul 2021 20:21:08.915 # +sdown master mymaster 127.0.0.1 6379
36153:X 25 Jul 2021 20:21:09.010 # +odown master mymaster 127.0.0.1 6379 #quorum 2/2
36153:X 25 Jul 2021 20:21:09.010 # +new-epoch 1
36153:X 25 Jul 2021 20:21:09.010 # +try-failover master mymaster 127.0.0.1 6379
36153:X 25 Jul 2021 20:21:09.012 # +vote-for-leader 8d992c54df8f8677b0b345825f61fb733c73d14c 1
36153:X 25 Jul 2021 20:21:09.015 # 8d992c54df8f8677b0b345825f61fb733c73d14d voted for 8d992c54df8f8677b0b345825f61fb733c73d14c 1
36153:X 25 Jul 2021 20:21:09.075 # +elected-leader master mymaster 127.0.0.1 6379
36153:X 25 Jul 2021 20:21:09.075 # +failover-state-select-slave master mymaster 127.0.0.1 6379
36153:X 25 Jul 2021 20:21:09.141 # +selected-slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379
36153:X 25 Jul 2021 20:21:09.141 * +failover-state-send-slaveof-noone slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379
36153:X 25 Jul 2021 20:21:09.245 * +failover-state-wait-promotion slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379
36153:X 25 Jul 2021 20:21:09.705 # +promoted-slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379
36153:X 25 Jul 2021 20:21:09.705 # +failover-state-reconf-slaves master mymaster 127.0.0.1 6379
36153:X 25 Jul 2021 20:21:09.762 # +failover-end master mymaster 127.0.0.1 6379
36153:X 25 Jul 2021 20:21:09.762 # +switch-master mymaster 127.0.0.1 6379 127.0.0.1 6380
36153:X 25 Jul 2021 20:21:09.762 * +slave slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6380
36153:X 25 Jul 2021 20:21:19.866 # +sdown slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6380
36153:X 25 Jul 2021 20:21:53.686 # -sdown slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6380
36153:X 25 Jul 2021 20:22:03.684 * +convert-to-slave slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6380
36153:X 25 Jul 2021 20:29:15.279 * +reboot slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6380
```

# 配置cluster集群

## 配置文件
redis cluster 配置文件与单点redis配置文件是一样的，只是`cluster-enabled`参数需要开启，配置为`yes`，下面是最小的redis集群的配置文件，`nodes.conf`用于存储此节点的一些配置信息
```
# cluster0.conf
port 7000
cluster-enabled yes
cluster-config-file nodes0.conf
cluster-node-timeout 5000
appendonly yes

```
依次根据上面的配置文件生成端口分别为`7000、7001、7002、7003、7004、7005`，`cluster-config-file`分别为`nodes0.conf、nodes1.conf、nodes2.conf、nodes3.conf、nodes4.conf、nodes5.conf`的六个配置文件，然后在六个命令行窗口依次启动
```
redis-server cluster0.conf
redis-server cluster1.conf
redis-server cluster2.conf
redis-server cluster3.conf
redis-server cluster4.conf
redis-server cluster5.conf
```
由于没有nodes.conf文件不存在，每个节点都给自己一个新的ID
## 创建集群
选项 `--cluster-replicas 1` 表示为每一个主服务器配一个从服务器。其余的参数是要创建的集群中各实例的地址列表。
```
redis-cli --cluster create 127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 --cluster-replicas 1
```
输出如下，输入`yes`接受默认配置，输出`[OK] All 16384 slots covered.`集群配置成功。
```
>>> Performing hash slots allocation on 6 nodes...
Master[0] -> Slots 0 - 5460
Master[1] -> Slots 5461 - 10922
Master[2] -> Slots 10923 - 16383
Adding replica 127.0.0.1:7004 to 127.0.0.1:7000
Adding replica 127.0.0.1:7005 to 127.0.0.1:7001
Adding replica 127.0.0.1:7003 to 127.0.0.1:7002
>>> Trying to optimize slaves allocation for anti-affinity
[WARNING] Some slaves are in the same host as their master
M: 800713cc7c6b8bce5260bef7c3b7f0722b768031 127.0.0.1:7000
   slots:[0-5460] (5461 slots) master
M: 351306027fc63d9dbd39dc474d99b256b63f1105 127.0.0.1:7001
   slots:[5461-10922] (5462 slots) master
M: 249be29a2e3d50691e97f6828a21b4981c2fa92f 127.0.0.1:7002
   slots:[10923-16383] (5461 slots) master
S: ccce93cf3870aa5032195ac14b4c4e126c9e9a57 127.0.0.1:7003
   replicates 800713cc7c6b8bce5260bef7c3b7f0722b768031
S: dd1e995567b9a1cefbb1c667004ec69fdb0c19a0 127.0.0.1:7004
   replicates 351306027fc63d9dbd39dc474d99b256b63f1105
S: 7dc00768dc2c2e285da502070603ff127040c810 127.0.0.1:7005
   replicates 249be29a2e3d50691e97f6828a21b4981c2fa92f
Can I set the above configuration? (type 'yes' to accept): yes
>>> Nodes configuration updated
>>> Assign a different config epoch to each node
>>> Sending CLUSTER MEET messages to join the cluster
Waiting for the cluster to join
.
>>> Performing Cluster Check (using node 127.0.0.1:7000)
M: 800713cc7c6b8bce5260bef7c3b7f0722b768031 127.0.0.1:7000
   slots:[0-5460] (5461 slots) master
   1 additional replica(s)
S: 7dc00768dc2c2e285da502070603ff127040c810 127.0.0.1:7005
   slots: (0 slots) slave
   replicates 249be29a2e3d50691e97f6828a21b4981c2fa92f
S: dd1e995567b9a1cefbb1c667004ec69fdb0c19a0 127.0.0.1:7004
   slots: (0 slots) slave
   replicates 351306027fc63d9dbd39dc474d99b256b63f1105
M: 249be29a2e3d50691e97f6828a21b4981c2fa92f 127.0.0.1:7002
   slots:[10923-16383] (5461 slots) master
   1 additional replica(s)
M: 351306027fc63d9dbd39dc474d99b256b63f1105 127.0.0.1:7001
   slots:[5461-10922] (5462 slots) master
   1 additional replica(s)
S: ccce93cf3870aa5032195ac14b4c4e126c9e9a57 127.0.0.1:7003
   slots: (0 slots) slave
   replicates 800713cc7c6b8bce5260bef7c3b7f0722b768031
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
```
使用`redis-cli -c -p 7000`即可连接上集群环境。
